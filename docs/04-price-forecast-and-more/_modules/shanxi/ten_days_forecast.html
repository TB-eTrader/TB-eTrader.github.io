<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <link rel="shortcut icon" href="../../_static/favicon.svg"/><!-- Generated with Sphinx 7.1.2 and Furo 2024.01.29 -->
        <title>shanxi.ten_days_forecast - price forecast and more 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=87c5882b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">price forecast and more 1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="sidebar-scroll"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">price forecast and more 1.0 documentation</span>
  
</a><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">快速开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">文档与接口</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for shanxi.ten_days_forecast</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Author: Sun Jiawei</span>
<span class="c1"># E-mail: sunjiawei@tbea.com</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. mod-doc::</span>

<span class="sd">    This package is the algorithm for ten days&#39; electricity price forecast</span>
<span class="sd">    for Shanxi province, including the node-ly price and transaction price.</span>

<span class="sd">    According to the trading rules of electricity market, each hour&#39;s price</span>
<span class="sd">    must in a specified price interval.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">date</span>

<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">and_</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">mysql</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.selectable</span> <span class="kn">import</span> <span class="n">Select</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">init_logger</span><span class="p">,</span> <span class="n">create_engine_and_tabs</span><span class="p">,</span> <span class="n">smooth_data</span><span class="p">,</span>
                   <span class="n">valid_month</span><span class="p">,</span> <span class="n">get_date_range</span><span class="p">,</span> <span class="n">DBDataLoad</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.deep_utils</span> <span class="kn">import</span> <span class="n">run_selu</span><span class="p">,</span> <span class="n">calc_month</span><span class="p">,</span> <span class="n">run_dml</span><span class="p">,</span> <span class="n">post_process</span><span class="p">,</span> <span class="n">save_result</span><span class="p">,</span> <span class="n">agg_date_time</span>

<span class="c1"># ====================================================================</span>
<span class="c1"># Setting zone start</span>
<span class="c1"># ====================================================================</span>
<span class="c1"># 关闭pandas链式赋值的警告</span>
<span class="c1"># ref: https://stackoverflow.com/a/53954986/6150878</span>
<span class="c1">#    : https://stackoverflow.com/a/20627316/6150878</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># 山西电力市场的唯一标识</span>
<span class="n">ProvinceId</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># 执行本算法需要用到的数据库表的名字</span>
<span class="n">TableNames</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;pt_load&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_connection_plan&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_node_price&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_clearing_price&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_prediction_clearing_price&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_hf_fc_168h_weather_01&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_hf_fc_30d_weather&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_hf_rt_weather&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_prediction_node_price_ml&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_tj_45d_1h_weather__partition_month&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_dp_general&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_station&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_plant_info&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_limited_price&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_contract&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_contract_detail&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_trade_strategy_ten_days&#39;</span><span class="p">]</span>
<span class="c1"># Length(number of days) of training data(for node price prediction)</span>
<span class="n">TrainDataLen</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">MarketId</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">NodeIds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="c1"># A map from node id to its model id.(None means clearing market)</span>
<span class="n">NodelyPriceMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kc">None</span><span class="p">:</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">8</span>
<span class="p">}</span>
<span class="n">TransPriceMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kc">None</span><span class="p">:</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">56</span>
<span class="p">}</span>
<span class="c1"># ====================================================================</span>
<span class="c1"># Setting zone end</span>
<span class="c1"># ====================================================================</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Ten days&#39; electricity price forecast algorithm for Shanxi province.&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;--remote_control&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to use the private cloud database&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--price_type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify the price type to be predicted, T for transaction price, N for node price.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to enable debug mode. If specified, &#39;</span>
                             <span class="s1">&#39;the private cloud database will not be used and `-R` will take no effect. &#39;</span>
                             <span class="s1">&#39;Also, the log will not be written to the file but printed to the console&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-E&#39;</span><span class="p">,</span> <span class="s1">&#39;--eval&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to get the real price to evaluate the result.&#39;</span>
                             <span class="s1">&#39;Specified this parameter when validating the model&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-M&#39;</span><span class="p">,</span> <span class="s1">&#39;--month&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">valid_month</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify the month to be predicted, format: YYYY-mm&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-T&#39;</span><span class="p">,</span> <span class="s1">&#39;--ten_days_order&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ten days order.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<div class="viewcode-block" id="next_ten_days"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.next_ten_days">[docs]</a><span class="k">def</span> <span class="nf">next_ten_days</span><span class="p">(</span><span class="n">specific_date</span><span class="p">:</span> <span class="n">date</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;根据给出的日期，确定下一个旬的起止日期及旬编号。</span>

<span class="sd">    编号与旬的对应关系为：1-&gt;上旬；2-&gt;中旬；3-&gt;下旬。</span>

<span class="sd">    :param specific_date: 指定的日期</span>
<span class="sd">    :return: 起止日期及旬编号组成的数组。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">specific_date</span><span class="p">:</span>
        <span class="n">specific_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">specific_date</span><span class="o">.</span><span class="n">day</span>

    <span class="n">next_month</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">today</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;11&#39;</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;20&#39;</span>
        <span class="n">ten_days_order</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">today</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">today</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;11&#39;</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;20&#39;</span>
            <span class="n">ten_days_order</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;21&#39;</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span>
            <span class="n">ten_days_order</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">today</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">today</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;21&#39;</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span>
            <span class="n">ten_days_order</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_month</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;10&#39;</span>
            <span class="n">ten_days_order</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># today // 10 == 3</span>
        <span class="n">next_month</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;10&#39;</span>
        <span class="n">ten_days_order</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">specific_date</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">specific_date</span><span class="o">.</span><span class="n">month</span>

    <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">12</span> <span class="ow">and</span> <span class="n">next_month</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">month</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">next_month</span><span class="p">:</span>
        <span class="n">month</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">start_date</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">end_date</span> <span class="o">==</span> <span class="s1">&#39;END&#39;</span><span class="p">:</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">ten_days_order</span></div>


<div class="viewcode-block" id="get_raw_sql"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.get_raw_sql">[docs]</a><span class="k">def</span> <span class="nf">get_raw_sql</span><span class="p">(</span><span class="n">statement</span><span class="p">:</span> <span class="n">Select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;根据 ``statement`` 生成原生SQL。&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">statement</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">mysql</span><span class="o">.</span><span class="n">dialect</span><span class="p">(),</span> <span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;literal_binds&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="get_hour"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.get_hour">[docs]</a><span class="k">def</span> <span class="nf">get_hour</span><span class="p">(</span><span class="n">hm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;将&quot;hh:mm&quot;的时间字符串转化为&quot;hh:00&quot;。如果本来&quot;mm&quot;就为&quot;00&quot;，则将hh减1。</span>

<span class="sd">    :param hm_string: 时间字符串</span>
<span class="sd">    :return: 整小时字符串。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hm_string</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;00&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hm_string</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">hm_string</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;10&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hm_string</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:00&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hm_string</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:00&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hm_string</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:00&#39;</span></div>


<div class="viewcode-block" id="str_2_date"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.str_2_date">[docs]</a><span class="k">def</span> <span class="nf">str_2_date</span><span class="p">(</span><span class="n">date_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">date</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;日期格式化为 ``date`` 类型。&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span></div>


<div class="viewcode-block" id="str_date"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.str_date">[docs]</a><span class="k">def</span> <span class="nf">str_date</span><span class="p">(</span><span class="n">input_date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;``date`` 类型的日期转化为字符串。&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">input_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fill_weather_data"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.fill_weather_data">[docs]</a><span class="k">def</span> <span class="nf">fill_weather_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;分时天气预测数据可能会存在缺失的记录，此函数的功能是对其进行简单填充。</span>

<span class="sd">    :param df: 原始天气数据</span>
<span class="sd">    :param start_date: 开始日期</span>
<span class="sd">    :param end_date: 结束日期</span>
<span class="sd">    :return: 填充后的天气数据以及填充后的索引。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># noqa</span>
    <span class="n">hm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2022-1-1&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-1-2&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:00&#39;</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">dates</span><span class="p">,</span> <span class="n">hm</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span><span class="n">iterables</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">])</span>

    <span class="n">fill_value</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 首先判断第一个索引处是否有值,如果没有,则将后续的第一个值填充至第一个索引处</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">fill_value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">fill_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fill_indexes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fill_value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">fill_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
            <span class="n">fill_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fill_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
                        <span class="n">fill_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">fill_values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">fill_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">index</span></div>


<div class="viewcode-block" id="fea_train_weather_data"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.fea_train_weather_data">[docs]</a><span class="k">def</span> <span class="nf">fea_train_weather_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;对输入的、用于训练的天气实测据进行特征处理。&quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># 输入的df的字段必须包含zone,date和time.</span>
    <span class="c1"># date为字符型或日期类型,格式YYYY-mm-dd;time为字符型,格式HH:00.</span>
    <span class="c1"># df其余的字段的值应该为整型或浮点型</span>
    <span class="c1">#</span>
    <span class="k">assert</span> <span class="p">{</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="n">start_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">}))</span>
    <span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="c1"># 按区域取数</span>
    <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;晋北&#39;</span><span class="p">],</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;晋中&#39;</span><span class="p">],</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;晋南&#39;</span><span class="p">]</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">]</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;m_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">]</span>
    <span class="n">df3</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">]</span>
    <span class="n">fea_cols</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">df3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">))</span> <span class="o">*</span> <span class="mi">24</span><span class="p">:</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_df</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">的天气数据无需填充&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;获取</span><span class="si">{</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">天气数据有缺失,填充之...&#39;</span><span class="p">)</span>
        <span class="n">add_df</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fill_weather_data</span><span class="p">(</span><span class="n">_df</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
        <span class="n">_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">_df</span><span class="p">,</span> <span class="n">add_df</span><span class="p">))</span>
        <span class="n">_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_df</span><span class="p">)</span>
    <span class="n">wea_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wea_df</span><span class="p">,</span> <span class="n">fea_cols</span></div>


<div class="viewcode-block" id="fea_predict_weather_data"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.fea_predict_weather_data">[docs]</a><span class="k">def</span> <span class="nf">fea_predict_weather_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;对输入的、用于预测的天气预报数据进行特征处理。&quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># 输入的df的字段必须包含zone,date和time.</span>
    <span class="c1"># date为字符型或日期类型,格式YYYY-mm-dd;time为字符型,格式HH:00.</span>
    <span class="c1"># df其余的字段的值应该为整型或浮点型</span>
    <span class="c1">#</span>
    <span class="k">assert</span> <span class="p">{</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="n">start_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">}))</span>
    <span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># 按区域取数</span>
    <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;晋北&#39;</span><span class="p">],</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;晋中&#39;</span><span class="p">],</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;晋南&#39;</span><span class="p">]</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">]</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;m_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">]</span>
    <span class="n">df3</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">]</span>

    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">))</span> <span class="o">*</span> <span class="mi">24</span><span class="p">:</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_df</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">的天气数据无需填充&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;获取</span><span class="si">{</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">天气数据有缺失,填充之...&#39;</span><span class="p">)</span>
        <span class="n">add_df</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fill_weather_data</span><span class="p">(</span><span class="n">_df</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
        <span class="n">_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">_df</span><span class="p">,</span> <span class="n">add_df</span><span class="p">))</span>
        <span class="n">_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_df</span><span class="p">)</span>
    <span class="n">wea_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wea_df</span></div>


<div class="viewcode-block" id="combine_int_list"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.combine_int_list">[docs]</a><span class="k">def</span> <span class="nf">combine_int_list</span><span class="p">(</span><span class="n">a_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;判断一个由自然数组成的列表（已从小到大排序）中是否有连续的情况，如果有，则将其合并。&quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">a_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">])</span>  <span class="c1"># noqa</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="infer_date_n"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.infer_date_n">[docs]</a><span class="k">def</span> <span class="nf">infer_date_n</span><span class="p">(</span><span class="n">start_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;在预测节点分时价格时，用于确定训练集和预测集的起止日期。</span>

<span class="sd">    在实际的应用中，一般需要在距离目标旬还有数天的时候预测价格，因此，需要对训练集和预测集的起止日期进行调整。</span>
<span class="sd">    调整方式为：首先确定训练集的结束日期，然后据此日期来确定其他日期。</span>

<span class="sd">    确定训练集的结束日期的方式为：获取 ``start_date`` 之前的所有的供需数据和价格数据的最新的更新日期的最小值，</span>
<span class="sd">    并将其作为训练集的结束日期。</span>

<span class="sd">    :param start_date: 旬的开始日期</span>
<span class="sd">    :param end_date: 旬的结束日期</span>
<span class="sd">    :return: 训练集和预测集的起止日期。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">train_end_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;训练集结束日期的最大值为:</span><span class="si">{</span><span class="n">train_end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tab</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pt_load&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_connection_plan&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_node_price&#39;</span><span class="p">]:</span>
        <span class="n">tab_obj</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="n">tab</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tab</span> <span class="o">==</span> <span class="s1">&#39;pt_load&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">start_date</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="n">ProvinceId</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">power_type_id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="n">tab</span> <span class="o">==</span> <span class="s1">&#39;pt_connection_plan&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">start_date</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="n">ProvinceId</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">channel_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">start_date</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tab_obj</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">NodeIds</span><span class="p">)))</span>

        <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">max_date</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">max_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">train_end_date</span> <span class="o">=</span> <span class="n">max_date</span> <span class="k">if</span> <span class="n">max_date</span> <span class="o">&lt;</span> <span class="n">train_end_date</span> <span class="k">else</span> <span class="n">train_end_date</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tab</span><span class="si">}</span><span class="s1">表中在</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">之前的最新数据为</span><span class="si">{</span><span class="n">max_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">train_start_date</span> <span class="o">=</span> <span class="n">train_end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">TrainDataLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pred_start_date</span> <span class="o">=</span> <span class="n">train_end_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;确定的训练集的起止日期为:</span><span class="si">{</span><span class="n">train_start_date</span><span class="si">}</span><span class="s1"> ~ </span><span class="si">{</span><span class="n">train_end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;确定的预测集的起止日期为:</span><span class="si">{</span><span class="n">pred_start_date</span><span class="si">}</span><span class="s1"> ~ </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_start_date</span><span class="p">,</span> <span class="n">train_end_date</span><span class="p">,</span> <span class="n">pred_start_date</span><span class="p">,</span> <span class="n">end_date</span></div>


<div class="viewcode-block" id="infer_date_t"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.infer_date_t">[docs]</a><span class="k">def</span> <span class="nf">infer_date_t</span><span class="p">(</span><span class="n">start_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is used in transaction price prediction to determine</span>
<span class="sd">    the start and end date of train dataset and predict dataset, separately.</span>

<span class="sd">    In actual scenarios, prediction algorithm will be executed at some days</span>
<span class="sd">    before ``start_date``, thus the start and end date needed to be modified.</span>

<span class="sd">    :param start_date: Start date of ten-day</span>
<span class="sd">    :param end_date: End date of ten-day</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">got_it</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find available dates, start_date:</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">date_to_check</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">counter</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_load</span><span class="p">(</span><span class="n">date_to_check</span><span class="p">,</span> <span class="n">date_to_check</span><span class="p">,</span> <span class="n">power_type_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">got_it</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">got_it</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not find available dates&#39;</span><span class="p">)</span>

    <span class="n">train_end_date</span> <span class="o">=</span> <span class="n">date_to_check</span>
    <span class="n">train_start_date</span> <span class="o">=</span> <span class="n">date_to_check</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
    <span class="n">pred_start_date</span> <span class="o">=</span> <span class="n">date_to_check</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pred_end_date</span> <span class="o">=</span> <span class="n">end_date</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The modified train dataset dates: </span><span class="si">{</span><span class="n">train_start_date</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">train_end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The modified predict dataset dates: </span><span class="si">{</span><span class="n">pred_start_date</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">pred_end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_start_date</span><span class="p">,</span> <span class="n">train_end_date</span><span class="p">,</span> <span class="n">pred_start_date</span><span class="p">,</span> <span class="n">pred_end_date</span></div>


<div class="viewcode-block" id="TenDaysForecast"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast">[docs]</a><span class="k">class</span> <span class="nc">TenDaysForecast</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    预测旬度日前分时电价，包括两个节点和统一出清价格。</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ids</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">PriceType</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infer_date</span> <span class="o">=</span> <span class="n">infer_date_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infer_date</span> <span class="o">=</span> <span class="n">infer_date_n</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_feature</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 实测天气数据特征后的df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_feature</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 预测天气数据特征后的df</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;获取当前省份的节点及场站&#39;</span><span class="p">)</span>
        <span class="c1"># 根据province_id获取该省的所有场站id和节点id</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_station&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="n">ProvinceId</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sql:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">get_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_ids</span> <span class="o">=</span> <span class="n">node_ids</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">next_ten_days_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_ten_days_end</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">next_ten_days</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">county_2_area</span> <span class="o">=</span> <span class="p">{</span><span class="mi">101100208</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">101100207</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">101100206</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">101100904</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span>
                              <span class="mi">101100906</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span>
                              <span class="mi">101100903</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">101101005</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">101101013</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span> <span class="mi">101101008</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span>
                              <span class="mi">101101003</span><span class="p">:</span> <span class="s1">&#39;晋北&#39;</span><span class="p">,</span>
                              <span class="mi">101101103</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101101109</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101101111</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101101110</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span>
                              <span class="mi">101100104</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span>
                              <span class="mi">101100103</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101100102</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101100407</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101100404</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span>
                              <span class="mi">101100410</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span>
                              <span class="mi">101100412</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101100302</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101100303</span><span class="p">:</span> <span class="s1">&#39;晋中&#39;</span><span class="p">,</span> <span class="mi">101100703</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span>
                              <span class="mi">101100710</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span>
                              <span class="mi">101100706</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100714</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100510</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100502</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span>
                              <span class="mi">101100509</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span>
                              <span class="mi">101100506</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100805</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100808</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100811</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span>
                              <span class="mi">101100813</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span>
                              <span class="mi">101100605</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100604</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100606</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">,</span> <span class="mi">101100603</span><span class="p">:</span> <span class="s1">&#39;晋南&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="TenDaysForecast.fn_wind_scale"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.fn_wind_scale">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fn_wind_scale</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;处理 ``windScale`` 值。&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="TenDaysForecast.find_most_similar"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.find_most_similar">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_most_similar</span><span class="p">(</span><span class="n">zone</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_val</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">agg_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;根据 ``base_val`` 在 ``agg_df`` 中寻找同一个大区下天气状况最相似的区县及对应日期。&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">agg_df</span><span class="p">[</span><span class="n">agg_df</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zone</span><span class="p">]</span>
        <span class="n">sim_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sim_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="n">tar_val</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">tar_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">tar_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">base_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tar_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">base_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tar_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">tar_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">base_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tar_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">base_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cosine</span><span class="p">(</span><span class="n">tar_val</span><span class="p">,</span> <span class="n">base_val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sim_max</span> <span class="o">&lt;</span> <span class="n">sim</span><span class="p">:</span>
                <span class="n">sim_max</span> <span class="o">=</span> <span class="n">sim</span>
                <span class="n">sim_idx</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sim_idx</span><span class="p">]</span><span class="o">.</span><span class="n">cityId</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sim_idx</span><span class="p">]</span><span class="o">.</span><span class="n">date</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_holiday_feature</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;向 ``df`` 中增加用于表示当前样本是否处于法定节假日的列。&quot;&quot;&quot;</span>
        <span class="n">legal_holidays</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;2023-1-21&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-1-27&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;2023-4-5&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-4-5&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;2023-4-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-5-3&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;2023-6-22&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-6-24&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;2023-9-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-10-6&#39;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">legal_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">legal_holidays</span><span class="p">:</span>
            <span class="n">legal_dates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>  <span class="c1"># noqa</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="n">new_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">legal_dates</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_legal_holiday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_col</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;is_legal_holiday&#39;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_ts_feature</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;根据时间戳构造特征。&quot;&quot;&quot;</span>
        <span class="n">is_peek</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 是否用电高峰</span>
        <span class="n">hour_no</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 当前时间戳的所属小时</span>
        <span class="n">weekday_no</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 当前日期是周几</span>
        <span class="n">month_no</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 当前日期所属的月份</span>
        <span class="n">is_weekend</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 是否为周末</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>

            <span class="n">hour_no</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>

            <span class="k">if</span> <span class="mi">10</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">is_peek</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_peek</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">wd</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

            <span class="n">weekday_no</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">wd</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
                <span class="n">is_weekend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_weekend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">month_no</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_peek&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_peek</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_weekend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_weekend</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour_no</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;weekday_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weekday_no</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;month_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">month_no</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;is_peek&#39;</span><span class="p">,</span> <span class="s1">&#39;is_weekend&#39;</span><span class="p">,</span> <span class="s1">&#39;hour_no&#39;</span><span class="p">,</span> <span class="s1">&#39;weekday_no&#39;</span><span class="p">,</span> <span class="s1">&#39;month_no&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="TenDaysForecast.save_to_db"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.save_to_db">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_to_db</span><span class="p">(</span><span class="n">price</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">,</span>
                   <span class="n">node_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从预测结果中筛选出下一个旬度的数据，并将其写入数据库。&quot;&quot;&quot;</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">PriceMap</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>

        <span class="n">start_date</span> <span class="o">=</span> <span class="n">str_2_date</span><span class="p">(</span><span class="n">StartDate</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">str_2_date</span><span class="p">(</span><span class="n">EndDate</span><span class="p">)</span>

        <span class="n">insert_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_date</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_date</span> <span class="o">&lt;</span> <span class="n">start_date</span> <span class="ow">or</span> <span class="n">_date</span> <span class="o">&gt;</span> <span class="n">end_date</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tm</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;0</span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s1">:00&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s1">:00&#39;</span>
            <span class="k">if</span> <span class="n">node_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">insert_values</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                                      <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">tm</span><span class="p">,</span> <span class="s1">&#39;node_id&#39;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">insert_values</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                                      <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">tm</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">,</span> <span class="s1">&#39;province_id&#39;</span><span class="p">:</span> <span class="n">ProvinceId</span><span class="p">})</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_prediction_node_price_ml&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">node_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_prediction_clearing_price&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c1"># 先删除</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">model_id</span><span class="p">))</span>
            <span class="c1"># 再插入</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                <span class="n">insert_values</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;入库完成&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TenDaysForecast.save_cache"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.save_cache">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_cache</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">,</span> <span class="n">value_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;将中间过程的预测数据进行存储。&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">sqlite3</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;cache.db&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS ten_days_cache_table(</span>
<span class="s2">            id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">            date TEXT,</span>
<span class="s2">            time TEXT,</span>
<span class="s2">            new_energy REAL,</span>
<span class="s2">            out_load REAL,</span>
<span class="s2">            in_load REAL,</span>
<span class="s2">            fcst_ts TEXT</span>
<span class="s2">        )</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;存储过程数据...&#39;</span><span class="p">)</span>
        <span class="n">sqlite_engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///cache.db&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;ten_days_cache_table&#39;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(),</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">sqlite_engine</span><span class="p">)</span>
        <span class="n">insert_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_date</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_date</span><span class="p">)</span>
            <span class="n">tm</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;0</span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s1">:00&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s1">:00&#39;</span>

            <span class="n">insert_values</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">tm</span><span class="p">,</span>
                                  <span class="s1">&#39;new_energy&#39;</span><span class="p">:</span> <span class="n">value_df</span><span class="p">[</span><span class="s1">&#39;新能源负荷&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;out_load&#39;</span><span class="p">:</span> <span class="n">value_df</span><span class="p">[</span><span class="s1">&#39;外送&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="s1">&#39;in_load&#39;</span><span class="p">:</span> <span class="n">value_df</span><span class="p">[</span><span class="s1">&#39;省调负荷&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;fcst_ts&#39;</span><span class="p">:</span> <span class="n">ts</span>
                                  <span class="p">})</span>
        <span class="k">with</span> <span class="n">sqlite_engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c1"># 先删除</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">dates</span><span class="p">)))</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                <span class="n">insert_values</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;入库完成&#39;</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_single_day_data</span><span class="p">(</span><span class="n">data_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取单日的数据。&quot;&quot;&quot;</span>
        <span class="n">pt_load</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_load&#39;</span><span class="p">]</span>
        <span class="n">pcp</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_connection_plan&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">power_type_id</span><span class="p">,</span>
                   <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;负荷&#39;</span><span class="p">),</span> <span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;外送&#39;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">pt_load</span><span class="p">,</span> <span class="n">pcp</span><span class="p">,</span>
                       <span class="n">and_</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                            <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span> <span class="o">==</span> <span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">channel_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">power_type_id</span><span class="o">.</span><span class="n">in_</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                   <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">data_date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">192</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_date</span><span class="si">}</span><span class="s1">日的数据不完整(缺少负荷或联络线)&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">192</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;24:00&#39;</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;00:00&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]</span>

        <span class="n">df_province</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;power_type_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;负荷&#39;</span><span class="p">:</span> <span class="s1">&#39;省调负荷&#39;</span><span class="p">})</span>
        <span class="n">df_ne</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;power_type_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">][[</span><span class="s1">&#39;负荷&#39;</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;负荷&#39;</span><span class="p">:</span> <span class="s1">&#39;新能源负荷&#39;</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df_province</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_ne</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;power_type_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># 竞价空间=省调负荷+外送计划总量-新能源负荷</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;竞价空间&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;省调负荷&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;外送&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;新能源负荷&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">node_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt_node_price</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_node_price&#39;</span><span class="p">]</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">pt_node_price</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ahead_day_price</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_node_price</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">node_id</span> <span class="o">==</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">pt_node_price</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">data_date</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pt_node_price</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">price_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">price_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_date</span><span class="si">}</span><span class="s1">日的日前节点(node_id=</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">)电价数据不完整&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;实际价格&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;ahead_day_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 统一出清价格</span>
            <span class="n">price_tab</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_clearing_price&#39;</span><span class="p">]</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">price_tab</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">price_tab</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">data_date</span><span class="p">,</span> <span class="n">price_tab</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">price_tab</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">price_tab</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">price_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">price_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_date</span><span class="si">}</span><span class="s1">日的日前统一出清价格数据不完整&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;实际价格&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_date</span><span class="si">}</span><span class="s1">日的数据读取并处理完成&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="TenDaysForecast.get_train_data"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.get_train_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_train_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从数据库中读取用于训练的原始数据。</span>

<span class="sd">        由于部分数据存在缺失，因此逐日读取数据。如果当日的数据存在缺失，则向前后退一日进行读取。</span>

<span class="sd">        :param node_id: 节点id</span>
<span class="sd">        :return: 训练数据。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 新能源负荷</span>
        <span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;逐日读取数据...&#39;</span><span class="p">)</span>
        <span class="n">base_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_single_day_data</span><span class="p">(</span><span class="n">base_date</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;获取了</span><span class="si">{</span><span class="n">base_date</span><span class="si">}</span><span class="s1">日的全部数据&#39;</span><span class="p">)</span>
                    <span class="n">base_date</span> <span class="o">-=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_date</span><span class="si">}</span><span class="s1">日的数据有缺失,向前顺延&#39;</span><span class="p">)</span>
                    <span class="n">base_date</span> <span class="o">-=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">ret</span><span class="p">])</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_hour</span><span class="p">)</span>
        <span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">[[</span><span class="s1">&#39;省调负荷&#39;</span><span class="p">,</span> <span class="s1">&#39;外送&#39;</span><span class="p">,</span> <span class="s1">&#39;新能源负荷&#39;</span><span class="p">,</span> <span class="s1">&#39;实际价格&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df</span></div>

    <span class="k">def</span> <span class="nf">add_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_holiday_feature</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_ts_feature</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f1</span> <span class="o">+</span> <span class="n">f2</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RandomForestRegressor</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;根据各价格种类，训练不同的模型&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_ids</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_ids</span><span class="p">)</span><span class="si">}</span><span class="s1">)节点</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;获取数据...&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_data</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;增加特征...&#39;</span><span class="p">)</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;新能源负荷&#39;</span><span class="p">,</span> <span class="s1">&#39;外送&#39;</span><span class="p">,</span> <span class="s1">&#39;省调负荷&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">features</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;特征列:&#39;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;实际价格&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;建模并训练...&#39;</span><span class="p">)</span>

            <span class="n">_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">_model</span>

        <span class="k">return</span> <span class="n">models</span>

<div class="viewcode-block" id="TenDaysForecast.predict_inner_data"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.predict_inner_data">[docs]</a>    <span class="k">def</span> <span class="nf">predict_inner_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is the inner part of the main prediction.</span>

<span class="sd">        For node price prediction, new energy power data, outer load data</span>
<span class="sd">        and provincial load data will be predicted to forecast the final price.</span>

<span class="sd">        For transaction price prediction, only new energy power data will be</span>
<span class="sd">        predicted to forecast the final price. Moreover, new energy power data</span>
<span class="sd">        is separated into 2 parts: wind power data and solar power data.</span>

<span class="sd">        Both the 2 above processes are supported by weather (forecast) data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">PriceType</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prepare the weather data(from hefeng)...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_weather_data</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get the forecasted new energy power data ...&#39;</span><span class="p">)</span>
            <span class="n">new_energy_power_forecast_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_energy_power_forecast</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get the forecasted outer load data ...&#39;</span><span class="p">)</span>
            <span class="n">inter_pro_load_forecast_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_pro_load_forecast</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get the forecasted provincial load data ...&#39;</span><span class="p">)</span>
            <span class="n">provincial_load_forecast_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provincial_load_forecast</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;For each node(clearing) price, train a price predicting model ...&#39;</span><span class="p">)</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">new_energy_power_forecast_values</span><span class="p">,</span> <span class="n">inter_pro_load_forecast_values</span><span class="p">,</span> <span class="n">provincial_load_forecast_values</span><span class="p">,</span> <span class="n">models</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prepare to forecast wind power data ...&#39;</span><span class="p">)</span>
            <span class="n">wind_speed_df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_data_from_tj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">wind_power_df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span><span class="p">,</span> <span class="n">power_type_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">wind_power_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value_6_3&#39;</span><span class="p">:</span> <span class="s1">&#39;y_value&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">agg_date_time</span><span class="p">(</span><span class="n">wind_power_df</span><span class="p">)</span>
            <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">wind_speed_df</span><span class="p">,</span> <span class="n">wind_power_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">train_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No data loaded!&#39;</span><span class="p">)</span>
            <span class="n">wind_speed_df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_data_from_tj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">wind_res</span> <span class="o">=</span> <span class="n">run_selu</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">wind_speed_df</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prepare to forecast solar power data ...&#39;</span><span class="p">)</span>
            <span class="n">solar_irr_df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_data_from_tj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
            <span class="n">solar_power_df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span><span class="p">,</span> <span class="n">power_type_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">solar_power_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value_7_3&#39;</span><span class="p">:</span> <span class="s1">&#39;y_value&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">agg_date_time</span><span class="p">(</span><span class="n">solar_power_df</span><span class="p">)</span>
            <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">solar_irr_df</span><span class="p">,</span> <span class="n">solar_power_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">train_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No data loaded!&#39;</span><span class="p">)</span>
            <span class="n">solar_power_df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_data_from_tj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
            <span class="n">solar_res</span> <span class="o">=</span> <span class="n">run_selu</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">solar_power_df</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Forecast new energy data ...&#39;</span><span class="p">)</span>
            <span class="n">power_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">power_result</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">wind_res</span><span class="o">.</span><span class="n">index</span>
            <span class="n">power_result</span><span class="p">[</span><span class="s1">&#39;y_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_res</span><span class="p">[</span><span class="s1">&#39;y_value&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">solar_res</span><span class="p">[</span><span class="s1">&#39;y_value&#39;</span><span class="p">]</span>
            <span class="n">power_result</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;y_value&#39;</span><span class="p">:</span> <span class="s1">&#39;load&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hourly</span> <span class="o">=</span> <span class="n">power_result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">power_result</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="p">)[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># noqa</span>
            <span class="n">hourly</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hourly</span></div>

<div class="viewcode-block" id="TenDaysForecast.predict_final_price"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.predict_final_price">[docs]</a>    <span class="k">def</span> <span class="nf">predict_final_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_tuple</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;According to the inner data, predicting the final price and save.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start to predict the final price ...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PriceType</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_tuple</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
            <span class="n">new_energy_power_forecast_values</span><span class="p">,</span> <span class="n">inter_pro_load_forecast_values</span><span class="p">,</span> <span class="n">provincial_load_forecast_values</span><span class="p">,</span> <span class="n">models</span> <span class="o">=</span> <span class="n">in_tuple</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Predicting the final price ...&#39;</span><span class="p">)</span>
            <span class="n">periods</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">))</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">periods</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span>
                                  <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:00&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                <span class="n">hours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">mul_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span><span class="n">dates</span><span class="p">,</span> <span class="n">hours</span><span class="p">])</span>
            <span class="n">predict_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;新能源负荷&#39;</span><span class="p">:</span> <span class="n">new_energy_power_forecast_values</span><span class="p">,</span>
                                            <span class="s1">&#39;外送&#39;</span><span class="p">:</span> <span class="n">inter_pro_load_forecast_values</span><span class="p">,</span>
                                            <span class="s1">&#39;省调负荷&#39;</span><span class="p">:</span> <span class="n">provincial_load_forecast_values</span><span class="p">,</span>
                                            <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">mul_index</span><span class="p">)</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">predict_df</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;新能源负荷&#39;</span><span class="p">,</span> <span class="s1">&#39;外送&#39;</span><span class="p">,</span> <span class="s1">&#39;省调负荷&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">features</span>
            <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;节点</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s1">的预测模型未被成功训练,无法预测该节点的价格&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
                <span class="n">forecast_price</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predict_df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s1">节点预测完成,开始入库...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">(</span><span class="n">forecast_price</span><span class="p">,</span> <span class="n">mul_index</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_df</span> <span class="o">=</span> <span class="n">in_tuple</span>
            <span class="n">ten_days_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="o">.</span><span class="n">day</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">month_num</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">start_month_anchor</span> <span class="o">=</span> <span class="n">calc_month</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">),</span> <span class="n">month_num</span><span class="p">)</span>
            <span class="n">end_month_anchor</span> <span class="o">=</span> <span class="n">calc_month</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">df_price</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_hourly_transaction_price_t</span><span class="p">(</span><span class="n">start_month_anchor</span><span class="p">,</span> <span class="n">end_month_anchor</span><span class="p">,</span> <span class="n">ten_days_order</span><span class="p">)</span>
            <span class="n">df_load</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_hourly_ne_load</span><span class="p">(</span><span class="n">start_month_anchor</span><span class="p">,</span> <span class="n">end_month_anchor</span><span class="p">,</span> <span class="n">ten_days_order</span><span class="p">)</span>
            <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_price</span><span class="p">,</span> <span class="n">df_load</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pred_df</span> <span class="o">=</span> <span class="n">run_dml</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">pred_df</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Post processing...&#39;</span><span class="p">)</span>
            <span class="n">post_process</span><span class="p">(</span><span class="n">pred_df</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">Month</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Post processing finished&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Eval</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get real price and evaluate the model...&#39;</span><span class="p">)</span>
                <span class="c1"># todo</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving results...&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_nid</span> <span class="ow">in</span> <span class="n">NodeIds</span><span class="p">:</span>
                    <span class="n">save_result</span><span class="p">(</span><span class="n">pred_df</span><span class="p">,</span> <span class="n">StartDate</span><span class="p">,</span> <span class="n">EndDate</span><span class="p">,</span>
                                <span class="n">tab_dict</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">ProvinceId</span><span class="p">,</span> <span class="n">PriceMap</span><span class="p">[</span><span class="n">_nid</span><span class="p">],</span> <span class="n">MarketId</span><span class="p">,</span> <span class="n">_nid</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Results saved&#39;</span><span class="p">)</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="TenDaysForecast.run"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;价格预测算法的入口函数。</span>

<span class="sd">        :param start_date: 旬的起始日期</span>
<span class="sd">        :param end_date: 旬的结束日期</span>
<span class="sd">        :return: ``None``，直接在数据库中保存预测结果。</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;确定训练集与预测集的起止日期...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">infer_date</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;日期已确定&#39;</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_inner_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_final_price</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span></div>

<div class="viewcode-block" id="TenDaysForecast.prepare_weather_data"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysForecast.prepare_weather_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_weather_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;读取并处理天气实测数据与预报数据。&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取实测数据并处理...&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_hf_rt_weather&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cityId</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windSpeed</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                   <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cityId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">county_2_area</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取实测天气数据的sql:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">get_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span><span class="p">[</span><span class="s1">&#39;windSpeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span><span class="p">[</span><span class="s1">&#39;windSpeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;数据读取完成, 增加区域信息...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_zone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span><span class="p">[</span><span class="s1">&#39;cityId&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;完成&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取预测数据并处理...&#39;</span><span class="p">)</span>
        <span class="c1"># 在读取天气预报数据时,需要从两部分获取数据:一是分时天气预报,共168h,二是未来30d的天气预报数据</span>
        <span class="c1"># 为了适应代码,需要将30天的数据做分时处理</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取168h预测数据...&#39;</span><span class="p">)</span>
        <span class="n">df_168h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_168h_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;wind360&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;wind360&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;完成&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取30d预测数据...&#39;</span><span class="p">)</span>
        <span class="n">df_30d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_30d_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># 对30d中的数据,仅保留168h数据之后的部分</span>
        <span class="n">df_30d</span> <span class="o">=</span> <span class="n">df_30d</span><span class="p">[</span><span class="n">df_30d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

        <span class="n">df_30d</span><span class="p">[</span><span class="s1">&#39;wind360Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_30d</span><span class="p">[</span><span class="s1">&#39;wind360Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df_30d</span><span class="p">[</span><span class="s1">&#39;wind360Night&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_30d</span><span class="p">[</span><span class="s1">&#39;wind360Night&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;完成&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;根据168h数据填充30d天气至分时数据...&#39;</span><span class="p">)</span>
        <span class="n">df_30d_expand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_30d_data</span><span class="p">(</span><span class="n">df_30d</span><span class="p">,</span> <span class="n">df_168h</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;完成&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;拼接168h与填充后的30d数据...&#39;</span><span class="p">)</span>
        <span class="c1"># 仅保留预测日期内的168h数据</span>
        <span class="n">df_168h</span> <span class="o">=</span> <span class="n">df_168h</span><span class="p">[</span><span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_30d_expand</span><span class="p">,</span>
                                         <span class="n">df_168h</span><span class="p">[[</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;windSpeed&#39;</span><span class="p">,</span> <span class="s1">&#39;cloud&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]]],</span>
                                        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;拼接完成&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read_168h_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;读取168h的天气预报数据。&quot;&quot;&quot;</span>
        <span class="c1"># 从self.predict_start_date-1开始,向前寻找最新一次的预测的168h数据</span>
        <span class="n">target_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_hf_fc_168h_weather_01&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">str_date</span><span class="p">(</span><span class="n">target_date</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span><span class="o">.</span><span class="n">one</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_date</span> <span class="o">-=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;最近一次的168h数据是</span><span class="si">{</span><span class="n">target_date</span><span class="si">}</span><span class="s1">更新的,读取该部分数据...&#39;</span><span class="p">)</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windSpeed</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fxDate</span><span class="p">,</span>
                   <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">wind360</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windDir</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windScale</span><span class="p">,</span>
                   <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">humidity</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">precip</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fxTimeVar</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cityId</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">str_date</span><span class="p">(</span><span class="n">target_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span> <span class="o">==</span> <span class="s1">&#39;23:00&#39;</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cityId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">county_2_area</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取数据的sql:&#39;</span> <span class="o">+</span> <span class="n">get_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="c1"># 对任一cityId,df中的数据是从target_date+1 00:00开始,至target_date+7 23:00止,共168条数据</span>

        <span class="c1"># df = df[df[&#39;fxDate&#39;] &gt;= self.predict_start_date]  # 仅取测试集部分的数据</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;测试日期内168h预测数据为空&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fxDate&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;fxTimeVar&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;划分区域...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_zone</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_30d_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;读取30d的天气预报数据。&quot;&quot;&quot;</span>
        <span class="c1"># 从self.predict_start_date-1开始,向前寻找最新一次的预测的30d数据</span>
        <span class="n">target_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_hf_fc_30d_weather&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">str_date</span><span class="p">(</span><span class="n">target_date</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span><span class="o">.</span><span class="n">one</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_date</span> <span class="o">-=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;最近一次的30d数据是</span><span class="si">{</span><span class="n">target_date</span><span class="si">}</span><span class="s1">更新的,读取该部分数据...&#39;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">tempMin</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">tempMax</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">textDay</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">textNight</span><span class="p">,</span>
                   <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windSpeedDay</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windSpeedNight</span><span class="p">,</span>
                   <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">wind360Day</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">wind360Night</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">humidity</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">precip</span><span class="p">,</span>
                   <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windScaleDay</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">windScaleNight</span><span class="p">,</span>
                   <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fxDate</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cityId</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">str_date</span><span class="p">(</span><span class="n">target_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fxDate</span> <span class="o">&lt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span><span class="p">))</span>  <span class="c1"># 仅取测试集部分的数据</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fxDate</span> <span class="o">&gt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cityId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">county_2_area</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取数据的sql:&#39;</span> <span class="o">+</span> <span class="n">get_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;测试日期内30d预测数据为空&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fxDate&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;划分区域...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_zone</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;原始的天气数据为区县粒度，增加一列用于表示当前区县属于晋北，晋中和晋南的哪个部分。</span>

<span class="sd">        :param df: 原始天气数据</span>
<span class="sd">        :return: 修改后的dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cityId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">county_2_area</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_expand_30d_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_30d</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_168h</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;对日天气预报数据扩充至24h。</span>

<span class="sd">        扩充的原则：将_168_data中的数据分区县按日聚合，对主要指标求平均值；然后对于_30d_data中</span>
<span class="sd">        的某一行数据，计算其与该地区的所有区县的分时预报聚合数据的相似度，选取最相似的作为该行数据的日分时天气预报数据。</span>

<span class="sd">        :param df_30d: 30日天气预报数据</span>
<span class="sd">        :param df_168h: 168小时天气预报数据</span>
<span class="sd">        :return: 扩充后的数据。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;对168h数据进行聚合...&#39;</span><span class="p">)</span>
        <span class="c1"># 需要聚合的指标及处理方式:</span>
        <span class="c1">#   - temp,温度(计算24h的最大值与最小值)</span>
        <span class="c1">#   - text,天气状况的描述</span>
        <span class="c1">#   - wind360,360度风向(数字)</span>
        <span class="c1">#   - windDir,风向描述(文字转化为数值)</span>
        <span class="c1">#   - windScale,风力等级(计算24h的最大值与最小值)</span>
        <span class="c1">#   - windSpeed,风速(24h求平均值)</span>
        <span class="c1">#   - humidity,相对湿度(24h求平均值)</span>
        <span class="c1">#   - precip,降水量(24h求和)</span>
        <span class="c1">#   - cloud,云量(24h求平均值)</span>
        <span class="n">agg_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_date</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]):</span>
            <span class="n">sub_df_mid</span> <span class="o">=</span> <span class="n">df_168h</span><span class="p">[</span><span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">_date</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">city_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">sub_df_mid</span><span class="p">[</span><span class="s1">&#39;cityId&#39;</span><span class="p">]):</span>
                <span class="n">sub_df</span> <span class="o">=</span> <span class="n">sub_df_mid</span><span class="p">[</span><span class="n">sub_df_mid</span><span class="p">[</span><span class="s1">&#39;cityId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">city_id</span><span class="p">]</span>
                <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">day_cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;=</span> <span class="mi">18</span><span class="p">)</span>
                <span class="n">night_cond</span> <span class="o">=</span> <span class="o">-</span><span class="n">day_cond</span>
                <span class="n">temp_min</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">temp_max</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">text_day</span> <span class="o">=</span> <span class="n">sub_df</span><span class="p">[</span><span class="n">day_cond</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">text_night</span> <span class="o">=</span> <span class="n">sub_df</span><span class="p">[</span><span class="n">night_cond</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">wind_speed_day</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="n">day_cond</span><span class="p">]</span><span class="o">.</span><span class="n">windSpeed</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">wind_speed_night</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="n">night_cond</span><span class="p">]</span><span class="o">.</span><span class="n">windSpeed</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">humidity</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">humidity</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">precip</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">precip</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">cloud</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">wind_dir_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="n">day_cond</span><span class="p">]</span><span class="o">.</span><span class="n">wind360</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="n">wind_dir_night</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="n">night_cond</span><span class="p">]</span><span class="o">.</span><span class="n">wind360</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="n">wind_scale_tup</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">windScale</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_wind_scale</span><span class="p">)</span>
                <span class="n">ws_min</span><span class="p">,</span> <span class="n">ws_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wind_scale_tup</span><span class="p">)):</span>
                    <span class="n">_min</span><span class="p">,</span> <span class="n">_max</span> <span class="o">=</span> <span class="n">wind_scale_tup</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ws_min</span> <span class="o">&gt;</span> <span class="n">_min</span><span class="p">:</span>
                        <span class="n">ws_min</span> <span class="o">=</span> <span class="n">_min</span>
                    <span class="k">if</span> <span class="n">ws_max</span> <span class="o">&lt;</span> <span class="n">_max</span><span class="p">:</span>
                        <span class="n">ws_max</span> <span class="o">=</span> <span class="n">_max</span>
                <span class="n">agg_values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sub_df</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">city_id</span><span class="p">,</span> <span class="n">_date</span><span class="p">,</span>
                                   <span class="n">temp_min</span><span class="p">,</span> <span class="n">temp_max</span><span class="p">,</span> <span class="n">text_day</span><span class="p">,</span> <span class="n">text_night</span><span class="p">,</span>
                                   <span class="n">wind_speed_day</span><span class="p">,</span> <span class="n">wind_speed_night</span><span class="p">,</span> <span class="n">humidity</span><span class="p">,</span>
                                   <span class="n">precip</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span> <span class="n">wind_dir_day</span><span class="p">,</span> <span class="n">wind_dir_night</span><span class="p">,</span> <span class="n">ws_min</span><span class="p">,</span> <span class="n">ws_max</span><span class="p">])</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">agg_values</span><span class="p">,</span>
                              <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;cityId&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;tempMin&#39;</span><span class="p">,</span> <span class="s1">&#39;tempMax&#39;</span><span class="p">,</span> <span class="s1">&#39;textDay&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;textNight&#39;</span><span class="p">,</span> <span class="s1">&#39;windSpeedDay&#39;</span><span class="p">,</span> <span class="s1">&#39;windSpeedNight&#39;</span><span class="p">,</span> <span class="s1">&#39;humidity&#39;</span><span class="p">,</span> <span class="s1">&#39;precip&#39;</span><span class="p">,</span> <span class="s1">&#39;cloud&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;windDirDay&#39;</span><span class="p">,</span> <span class="s1">&#39;windDirNight&#39;</span><span class="p">,</span> <span class="s1">&#39;windScaleMin&#39;</span><span class="p">,</span> <span class="s1">&#39;windScaleMax&#39;</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;聚合完成&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;对30d数据进行相似度计算&#39;</span><span class="p">)</span>
        <span class="n">selected_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_30d</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">df_30d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">zone</span>
            <span class="n">temp_min</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">tempMin</span>
            <span class="n">temp_max</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">tempMax</span>
            <span class="n">text_day</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">textDay</span>
            <span class="n">text_night</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">textNight</span>
            <span class="n">wind_speed_day</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">windSpeedDay</span>
            <span class="n">wind_speed_night</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">windSpeedNight</span>
            <span class="n">wind_dir_day</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">wind360Day</span>
            <span class="n">wind_dir_night</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">wind360Night</span>
            <span class="n">humidity</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">humidity</span>
            <span class="n">precip</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">precip</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">cloud</span>
            <span class="n">wind_scale_day</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">windScaleDay</span>
            <span class="n">wind_scale_night</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">windScaleNight</span>
            <span class="n">min1</span><span class="p">,</span> <span class="n">max1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_wind_scale</span><span class="p">(</span><span class="n">wind_scale_day</span><span class="p">)</span>
            <span class="n">min2</span><span class="p">,</span> <span class="n">max2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_wind_scale</span><span class="p">(</span><span class="n">wind_scale_night</span><span class="p">)</span>
            <span class="n">wind_scale_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min1</span><span class="p">,</span> <span class="n">min2</span><span class="p">)</span>
            <span class="n">wind_scale_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max1</span><span class="p">,</span> <span class="n">max2</span><span class="p">)</span>
            <span class="n">base_val</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp_min</span><span class="p">,</span> <span class="n">temp_max</span><span class="p">,</span> <span class="n">text_day</span><span class="p">,</span> <span class="n">text_night</span><span class="p">,</span> <span class="n">wind_speed_day</span><span class="p">,</span>
                        <span class="n">wind_speed_night</span><span class="p">,</span> <span class="n">humidity</span><span class="p">,</span> <span class="n">precip</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span> <span class="n">wind_dir_day</span><span class="p">,</span>
                        <span class="n">wind_dir_night</span><span class="p">,</span> <span class="n">wind_scale_min</span><span class="p">,</span> <span class="n">wind_scale_max</span><span class="p">]</span>
            <span class="n">tar_city_id</span><span class="p">,</span> <span class="n">tar_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_most_similar</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">base_val</span><span class="p">,</span> <span class="n">agg_df</span><span class="p">)</span>
            <span class="n">tar_df</span> <span class="o">=</span> <span class="n">df_168h</span><span class="p">[(</span><span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;cityId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tar_city_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_168h</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tar_date</span><span class="p">)]</span>
            <span class="n">tar_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">date</span>
            <span class="n">selected_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tar_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">selected_dfs</span><span class="p">)[[</span><span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;windSpeed&#39;</span><span class="p">,</span> <span class="s1">&#39;cloud&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]]</span>

    <span class="c1"># 基于天气数据的新能源出力预测模型</span>
    <span class="k">def</span> <span class="nf">new_energy_power_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;训练一个模型用于预测新能源出力数据&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;读取训练数据...&#39;</span><span class="p">)</span>
        <span class="n">pt_load</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_load&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">power_type_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_start_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_end_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;读取新能源负荷的sql:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">get_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_hour</span><span class="p">)</span>
        <span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;hm&#39;</span><span class="p">])</span>
        <span class="n">load_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;对天气数据进行特征化处理...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_feature</span><span class="p">,</span> <span class="n">wea_cols</span> <span class="o">=</span> <span class="n">fea_train_weather_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_wea_df</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;数据合并&#39;</span><span class="p">)</span>
        <span class="n">whole_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">load_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_wea_feature</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">whole_df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">whole_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">wea_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">)</span>
        <span class="n">y_col</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
        <span class="n">x_cols</span> <span class="o">=</span> <span class="n">wea_cols</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;训练一个模型...&#39;</span><span class="p">)</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">whole_df</span><span class="p">[</span><span class="n">x_cols</span><span class="p">],</span> <span class="n">whole_df</span><span class="p">[</span><span class="n">y_col</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;预测新能源出力...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_feature</span> <span class="o">=</span> <span class="n">fea_predict_weather_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_feature</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_feature</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">predict_values</span> <span class="o">=</span> <span class="n">smooth_data</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_wea_feature</span><span class="p">[</span><span class="n">x_cols</span><span class="p">]),</span>
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ma&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">triangular</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predict_values</span>

    <span class="c1"># 基于时间序列的省间负荷预测</span>
    <span class="k">def</span> <span class="nf">inter_pro_load_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;训练一个模型用于预测省间负荷数据&#39;</span><span class="p">)</span>

        <span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="n">last_end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">last_start_date</span> <span class="o">=</span> <span class="n">last_end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
        <span class="n">pcp</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_connection_plan&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;获取省间负荷数据...&#39;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">channel_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="n">last_start_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="n">last_end_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;获取数据的sql:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">get_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_hour</span><span class="p">)</span>
        <span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;hm&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">[[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># 基于机器学习(利用天气数据和历史负荷数据)的省内负荷预测</span>
    <span class="k">def</span> <span class="nf">provincial_load_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;训练一个模型用于预测省内负荷数据&#39;</span><span class="p">)</span>
        <span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="n">last_end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">last_start_date</span> <span class="o">=</span> <span class="n">last_end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
        <span class="n">pt_load</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_load&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">market_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">power_type_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="n">last_start_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">str_date</span><span class="p">(</span><span class="n">last_end_date</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">pt_load</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># 滞后一天</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_hour</span><span class="p">)</span>
        <span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;hm&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">[[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>


<div class="viewcode-block" id="TenDaysDecisionSupport"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysDecisionSupport">[docs]</a><span class="k">class</span> <span class="nc">TenDaysDecisionSupport</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;依据预测的旬度价格，给出交易方向及报价。&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ten_days_order</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">price_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limited_price</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="TenDaysDecisionSupport.get_limited_price"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysDecisionSupport.get_limited_price">[docs]</a>    <span class="k">def</span> <span class="nf">get_limited_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;根据指定的年份，获取该年度旬交易的上下限价格。&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_limited_price&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">up</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">down</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quarter</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quarter</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;数据库中无上下限价格(year=2023)&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">quarter</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">quarter</span><span class="p">][</span><span class="s1">&#39;up&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">quarter</span><span class="p">][</span><span class="s1">&#39;down&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">limited_price</span><span class="p">[</span><span class="n">quarter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">lower</span><span class="p">}</span></div>

<div class="viewcode-block" id="TenDaysDecisionSupport.get_10days_forecast_price"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysDecisionSupport.get_10days_forecast_price">[docs]</a>    <span class="k">def</span> <span class="nf">get_10days_forecast_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取预测的旬度价格。&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_prediction_node_price_ml&#39;</span><span class="p">]</span>

        <span class="n">nid</span> <span class="o">=</span> <span class="n">station_id</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">node_id</span> <span class="o">==</span> <span class="n">nid</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">NodelyPriceMap</span><span class="p">[</span><span class="n">nid</span><span class="p">])</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># 对于山西的场站而言,默认从station_id=1获取对应的预测价格即可</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;旬度价格数据缺失(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TenDaysDecisionSupport.give_suggestion"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysDecisionSupport.give_suggestion">[docs]</a>    <span class="k">def</span> <span class="nf">give_suggestion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;给出建议。&quot;&quot;&quot;</span>
        <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="o">.</span><span class="n">month</span>
        <span class="n">season_order</span> <span class="o">=</span> <span class="p">(</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">upper_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limited_price</span><span class="p">[</span><span class="n">season_order</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
        <span class="n">lower_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limited_price</span><span class="p">[</span><span class="n">season_order</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>

        <span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_df</span><span class="p">)</span> <span class="o">//</span> <span class="mi">24</span><span class="p">)</span>
        <span class="n">market_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
            <span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">24</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_df</span><span class="p">)):</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">lower_price</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="c1"># 预测价格低于下限,建议卖出</span>
                    <span class="n">market_results</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">upper_price</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="c1"># 预测价格高于上限,建议买入</span>
                    <span class="n">market_results</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 预测价格在上下限之间,建议不操作</span>
                    <span class="n">market_results</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>

        <span class="c1"># 对每个市场的操作方向进行最终确定</span>
        <span class="n">suggestion</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">market_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">market_results</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">market_results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">vc</span> <span class="o">=</span> <span class="n">market_results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">vc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">{</span><span class="n">vc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">}):</span>
                        <span class="n">_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">vc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">_l</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                        <span class="n">suggestion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">_l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">suggestion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">suggestion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>

        <span class="c1"># 对每个市场的操作方向的电量进行确定</span>
        <span class="n">hourly_eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hold_ele</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hourly_eg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;场站</span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s1">的持有电量数据缺失(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;场站</span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s1">的持有电量数据缺失(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">insert_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 根据操作方向，确定申报价格和申报电量</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">suggestion</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">suggestion</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">time_interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;0</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:00-10:00&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time_interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;0</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:00-0</span><span class="si">{</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">:00&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:00-</span><span class="si">{</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">:00&#39;</span>

            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>  <span class="c1"># 卖出</span>
                <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limited_price</span><span class="p">[</span><span class="n">season_order</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># 申报价格为下限价</span>
                <span class="n">eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.75</span>  <span class="c1"># 申报电量为装机容量的75%</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>  <span class="c1"># 买入</span>
                <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limited_price</span><span class="p">[</span><span class="n">season_order</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># 申报价格为上限价</span>
                <span class="n">eg</span> <span class="o">=</span> <span class="n">hourly_eg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># 申报电量为全电量</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># 不操作</span>
                <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">eg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">insert_vals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;province_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;station_id&#39;</span><span class="p">:</span> <span class="n">station_id</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">),</span>
                <span class="s1">&#39;ten_days_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ten_days_order</span><span class="p">,</span>
                <span class="s1">&#39;time_interval&#39;</span><span class="p">:</span> <span class="n">time_interval</span><span class="p">,</span>
                <span class="s1">&#39;dircn_recommend&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span>
                <span class="s1">&#39;price_recommend&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;eg_recommend&#39;</span><span class="p">:</span> <span class="n">eg</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">insert_vals</span></div>

<div class="viewcode-block" id="TenDaysDecisionSupport.get_hold_ele"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysDecisionSupport.get_hold_ele">[docs]</a>    <span class="k">def</span> <span class="nf">get_hold_ele</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取指定场站的持有电量。&quot;&quot;&quot;</span>
        <span class="n">pt_contract</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_contract&#39;</span><span class="p">]</span>
        <span class="n">pt_contract_detail</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_contract_detail&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">([</span><span class="n">pt_contract</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_contract</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">station_id</span> <span class="o">==</span> <span class="n">station_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_contract</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_contract</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">contract_ids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contract_ids</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;场站(</span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s1">)在</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="si">}</span><span class="s1">期间没有持仓&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">([</span><span class="n">pt_contract_detail</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">pt_contract_detail</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eg</span><span class="p">])</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_contract_detail</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contract_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">contract_ids</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_contract_detail</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_contract_detail</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_hour</span><span class="p">)</span>
        <span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">)</span>
        <span class="n">hourly_eg</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">[</span><span class="s1">&#39;eg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 日均分时持仓电量</span>
        <span class="k">return</span> <span class="n">hourly_eg</span></div>

<div class="viewcode-block" id="TenDaysDecisionSupport.save"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysDecisionSupport.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suggestion</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;建议入库。&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tab_dict</span><span class="p">[</span><span class="s1">&#39;pt_trade_strategy_ten_days&#39;</span><span class="p">]</span>

        <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">and_</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">province_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">,</span>
                         <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ten_days_flag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ten_days_order</span><span class="p">,</span>
                         <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">station_id</span> <span class="o">==</span> <span class="n">suggestion</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;station_id&#39;</span><span class="p">]</span>
                         <span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">suggestion</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;建议入库失败&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="TenDaysDecisionSupport.support"><a class="viewcode-back" href="../../api.html#shanxi.ten_days_forecast.TenDaysDecisionSupport.support">[docs]</a>    <span class="k">def</span> <span class="nf">support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ten_days_order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;根据预测的价格生成决策。</span>

<span class="sd">        :param station_id: 场站id</span>
<span class="sd">        :param start_date: 旬度起始日期</span>
<span class="sd">        :param end_date: 旬度结束日期</span>
<span class="sd">        :param ten_days_order: 旬度序号</span>
<span class="sd">        :return: ``None``，直接入库。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ten_days_order</span> <span class="o">=</span> <span class="n">ten_days_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;获取预测价格...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_10days_forecast_price</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;过程出错&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;获取限价数据&#39;</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="o">.</span><span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_limited_price</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err_flag</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;过程出错&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;给出建议...&#39;</span><span class="p">)</span>
        <span class="n">sug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">give_suggestion</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;建议入库&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sug</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">init_logger</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n\n\n\n</span><span class="s1">args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">RemoteControl</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">remote_control</span>
    <span class="n">Month</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">month</span>
    <span class="n">TenDaysOrder</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ten_days_order</span>
    <span class="n">PriceType</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">price_type</span>
    <span class="n">Eval</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">eval</span>
    <span class="k">if</span> <span class="n">PriceType</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Predict transaction price&#39;</span><span class="p">)</span>
        <span class="n">PriceMap</span> <span class="o">=</span> <span class="n">TransPriceMap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Predict node price&#39;</span><span class="p">)</span>
        <span class="n">PriceMap</span> <span class="o">=</span> <span class="n">NodelyPriceMap</span>

    <span class="n">tab_dict</span><span class="p">,</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine_and_tabs</span><span class="p">(</span><span class="n">RemoteControl</span><span class="p">,</span> <span class="n">TableNames</span><span class="p">)</span>
    <span class="n">data_loader</span> <span class="o">=</span> <span class="n">DBDataLoad</span><span class="p">(</span><span class="n">ProvinceId</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">tab_dict</span><span class="p">)</span>

    <span class="c1"># 获取指定旬的起止日期</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;获取旬度起止日期...&#39;</span><span class="p">)</span>
    <span class="n">StartDate</span><span class="p">,</span> <span class="n">EndDate</span> <span class="o">=</span> <span class="n">get_date_range</span><span class="p">(</span><span class="n">Month</span><span class="p">,</span> <span class="n">TenDaysOrder</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;旬度起止日期为</span><span class="si">{</span><span class="n">StartDate</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="n">EndDate</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">forecaster</span> <span class="o">=</span> <span class="n">TenDaysForecast</span><span class="p">(</span><span class="n">NodeIds</span><span class="p">)</span>
    <span class="n">forecaster</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">StartDate</span><span class="p">,</span> <span class="n">EndDate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PriceType</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;给出决策建议...&#39;</span><span class="p">)</span>
    <span class="n">supporter</span> <span class="o">=</span> <span class="n">TenDaysDecisionSupport</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="n">supporter</span><span class="o">.</span><span class="n">support</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">StartDate</span><span class="p">,</span> <span class="n">EndDate</span><span class="p">,</span> <span class="n">TenDaysOrder</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;完成&#39;</span><span class="p">)</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, sunjiawei
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=359c27e9"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>